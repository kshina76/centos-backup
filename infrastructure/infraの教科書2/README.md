# インフラエンジニアの教科書2 メモ
- 参考文献
  - マルチプロセスとか色々な用語がわかりやすく述べられていて、さらにどのように実現しているかも述べていて、nginxのアーキテクチャにまで手を伸ばしている
    - https://qiita.com/kamihork/items/296ee689a8d48c2bebcd
# プロトコル
### ロードバランサー
- L3スイッチ: L3以下で動作するスイッチ、IPアドレスを見てスイッチング
- L4スイッチ/ロードバランサー: L4以下で動作するスイッチ、IPアドレス+ポートを見てスイッチング
- L7スイッチ/ロードバランサー: L7以下で動作するスイッチ、URLを見てスイッチング
- L4とかL7`以下`の`以下`が重要。決してL4だけで動作するからポートしか見ないのかと言われるとそういうわけではないので注意

### 独自プロトコル
- HTTP上で動作するL8に該当するプロトコルを構築してアプリケーションをその上で作成したりといったことがある
  - ゲームとか
- TCPを使っているHTTPより、もっとスリムで早く動作するプロトコルを作ってゲームを載せたりといったこともある
- SQLなども独自プロトコルを定義して通信されている
  - https://www.javadrive.jp/pear/pear_db/index2.html

  ![netag099](https://user-images.githubusercontent.com/53253817/102680024-2138d680-41f8-11eb-8c89-c1aa9c645e4a.gif)

### ジョン・ポステル博士への追悼文
- RFC2468
- RFC2441

### TCP
- トランスポート層でパケットを分割して、最初に以下の3-way-handshakeが行われる
  1. 送信元が通信路を確保するため、相手にデータ転送の許可要求を出す。（SYN）
  2. 宛先側が許可を送信元に知らせると同時に受信側も許可要求を出す。（ACK + SYN）
  3. 最初にSYNを送った送信元も宛先側に許可を出す。（ACK）
- 3-way-handshakeも普通のパケット同じように、「IP層->データリンク層->物理層」を通って相手に届く
  - ただし、シーケンス番号はランダムな値になる
- トランスポート層でデータがパケットに分解されて、トランスポート層を起点にパケットを一つ一つ流していく。そのパケットたちは「IP層->データリンク層->物理層」を通って相手のマシンに届く
- 一つのパケットが届くたびに、TCPの確認作業が入るため(ACKとかSYNとか)、UDPと比べて通信が遅くなる
- 参考文献
  - https://qiita.com/tatsuya4150/items/ae4d5e95e43ce0670bc0

### ICMP
- pingやtrace routeを遮断するような運用をしているサーバがあるが、「ブラックホールルータ」という現象が起きる可能性がある
- ブラックホールルータとは
  - ルータ間のMTUの調整ができなくなる問題がある
  - MTUの調整ができないと、パケットの分割が必要な時に、相手側のルータにそのことが伝えられずにパケットが失われる問題
- pingやtrace routeを防ぐ目的があるなら、ICMPの内の「Echo Reply」のみを遮断する方法が安全

### コネクションとセッションの違い

### FTP
- 制御用とデータ転送用の二つのTCPコネクションを使う
- FTPにはアクティブモードとパッシブモードがある
- P28の画像

### SNMP

### ファイアーウォールの機能
- 動的ポートフィルタリング

---

<br></br>

# OS
## プロセスとスレッド
### プロセスまとめ
- プロセスはOS上での処理の最小実行単位
- プロセスは、`ls`や`cd`の基本的なコマンドだろうが、スクリプトであろうが、OSSであろうが、商用ソフトであろうとも、OS上は全てプロセスの単位で実行される
- プロセスには親子関係があって、プロセスの生成は親プロセスを`複製(fork)`することでのみ行える。CoWという仕組みによって負荷を軽減してforkすることができる
- fork後は、`exec`と呼ばれるプロセスの中身を別のプログラムに丸ごと置き換える方法で処理を切り替えることができる
- プロセスは状態を遷移する
  1. 休止中
  2. 実行待ち
  3. 実行中
  4. etc
- プロセスは何かの処理を行う段階になると`実行待ち状態`に遷移する
- `実行待ち状態`でCPUからCPUリソース(CPUコア一つ)が割り当てられると、`実行中`に遷移する
- プロセス同士は共通のデータを参照・更新することができず、`プロセス間通信`という仕組みを介してデータの受け渡しを行う
- プロセスの制御は`シグナル`という仕組みで行う
  - 強制終了するとき`Ctrl-C`とかもシグナルの一種
### スレッドまとめ
- プロセスの内部に複数のスレッドを生成することができる。forkより軽い
- 同じプロセス内のスレッド同士は共通のデータの参照・更新をすることができる
- 複数のスレッドが競合して共通のデータが更新されないように`ミューテックス`や`セマフォ`などの排他制御の仕組みがある
- スレッドは軽量プロセスとも呼ばれ、OSからCPUの割り当てを受けてプロセスのように動作させることができる
- プロセスと違ってforkなどのシステムコールがないから生成時の負荷が小さい
- スレッドの例
  - ダウンロードとプログレスバー
### プロセスの構成要素
- PID
- プログラムの実行命令コード
- 変数などのデータ
- ファイル記述子(ファイルデスクリプタ、ファイルハンドルとも呼ぶ)
- コンテキスト(CPUの持つレジスタ情報や物理メモリのアドレッシングなどを保持しておき、コンテキストスイッチに備える)
- スレッド
### プロセスの親子関係と新しいプロセスの生成
- UNIX/LinuxはOS起動時にinitプロセスから起動する
- 全てのプロセスはinitプロセスの子孫プロセスになる
- `bash`を開いて、`lsコマンド`を処理する流れ
  - `bashプロセスA`を二つにfork->`bashプロセスA'`、`bashプロセスA''`->`bashプロセスA''`をexecシステムコールで`lsプロセスB`に書き換える
  - P38
### プロセス間通信
- `cat /var/log/messages | grep Error`のようなパイプ処理もプロセス間通信
  - catプロセスとgrepプロセスの通信は異なるプロセスなので、プロセス間通信
### 実行待ちキュー
- プロセスとスレッドが区別なく実行待ちキューな入っていて、CPUにリソースを割り当てられることで順番にキューから出ていく
- マルチコアCPUだとキューから複数のプロセスやスレッドを取っていくことができるので、ユーザが感じる速度が速くなる
### シグナル
- シグナルの種類
  - SIGHUP
  - SIGINT
  - SIGKILL
  - SIGTERM
  - SIGTSTP
- killコマンドで各種シグナルを送ることができる

<br></br>

## OSによるプロセス処理の仕組み
### タイムスライス
- CPUの処理時間をミリ秒単位で分割して、プロセス毎にCPUのリソースを割り当てる機能
### コンテキストスイッチ
- タイムスライスした後に、CPUが処理するプロセスを切り替えていくことをコンテキストスイッチという
- コンテキストスイッチが発生すると、CPUコアの各種レジスタ、プログラムカウンタ、プログラムポインタなどの状態がメモリのスタック領域に退避される
- メモリへの退避処理があるので、コンテキストスイッチは重い処理
### スケジューラーとディスパッチャ
- スケジューラーが次に実行するプロセスを選択する
- ディスパッチャがCPUのコアにプロセスを割り当てる
### ハイパースレッディング
- CPUコアを複数のコアがあるように見せる技術
- CPUのコアが増えるわけではない
- レジスタやパイプライン回路の空き時間を利用できる

<br></br>

## インフラエンジニアのプロセス管理の方法
- オペレーション技術として使える
### シングルプロセスかつシングルスレッドの処理速度の向上
- シングルプロセスかつシングルスレッドのプログラムは、プロセスが一つしかないのでCPUコアが一つしか使われない
- この場合は、クロック数が高いCPUに入れ替えると処理速度が向上する
### CPUコアを無駄なく使う
- CPU使用率が0%のものが目立つ場合は、さらにパフォーマンスをあげることができる可能性がある
- マルチプロセスのプログラムなら、設定でプロセス数を増やすことでさらにCPUコアに割り当てることができる
### コンテキストスイッチの発生を抑える
- 実行待ちのプロセスを減らすことで回避できる
- 例えば、シングルスレッドのプロセスが3つなら、CPUコアが3つあればコンテキストスイッチは発生しない
- golangのMAX_PROCESSでコア数以上に設定してしまうとコンテキストスイッチが発生してしまうかもしれない
### 特定プロセスの暴走
- CPU使用率が常に100%なら、ミドルウェアのバグやアプリケーションのバグを疑う
### 割り込み処理
- OSの割り込みは0番目のCPUコアを使おうとする
- irqbalanceサービスで、割り込み処理もそれぞれのCPUコアに分散させることができる

<br></br>

## メモリ
### メモリ管理まとめ
- プロセスがメモリアクセスする際は仮想メモリ空間を通して行う。物理メモリ空間には直接アクセスしない
- 空き物理メモリが不足していると、スワップアウト(もしくはページアウト)が発生する
- 空き物理メモリは不足していないが、物理メモリ空間のフラグメンテーションにより直ちにまとまった物理メモリ領域を確保できなくなった場合も、スワップアウト(もしくはページアウト)が発生することがある
### 仮想メモリ
- アプリケーションを作成する際に、メモリを意識したプログラミングが必要になりますが、物理メモリのアドレスをアプリケーション開発者が扱うのは極めて困難
- アプリケーション開発者が扱いやすいように、物理的にバラバラなアドレスを、連番でのアドレスとして扱えるようにしたのが仮想メモリ
- OSは、プロセスごとに独立した仮想メモリ(空間)を割り当てる。また、仮想メモリ空間を用途別に下記のように分類される
  - スタック領域
  - ヒープ領域
  - 静的データ領域
- 参考文献
  - https://teratail.com/questions/40760
### スワップ
- スワップ(HDD)に物理メモリに割り当てられているデータの一部を追い出して(スワップアウト)、物理メモリを確保する
  -「 物理メモリが不足した場合」と「フラグメンテーションによってまとまって確保できない場合」に発生する
- 逆にデータが必要になって物理メモリに戻すことをスワップインという
### スワップアウトとページアウトの違い
- スワップアウトはプログラムの一部という大きい単位でHDDにデータを追い出すこと
- ページアウトはページという小さい単位でHDDにデータを追い出すこと
  - 一般的なOSでは一つのページは4KBと決められている
- 現代だとスワップとページングを同じものとしていることも多い
### 仮想メモリ、物理メモリ、スワップの違い
- 物理的にバラバラなアドレスを、連番でのアドレスとして扱えるようにしたのが仮想メモリ
- HDDの一部の領域も仮想メモリのアドレスとして考えてしまうのがスワップ
- MMUによって「物理メモリのアドレス」<->「仮想メモリのアドレス」のマッピングを実現する
- MMU内のTLBによってキャッシュして高速化する

![swap-in-out-1](https://user-images.githubusercontent.com/53253817/102683660-db8b0680-4215-11eb-917e-ea7f15133186.png)

- 参考文献
  - https://milestone-of-se.nesuke.com/sv-basic/architecture/virtual-memory-and-swap/

### ページキャッシュ
- ディスクから読み込んだデータを捨てずに、ページ単位でメモリにキャッシュするOSの機能
- OSは空きメモリの大部分をページキャッシュとして使う
- ディスクI/Oが減るからパフォーマンスが向上する

<br></br>

## インフラエンジニアのメモリ管理の方法
- オペレーション技術として使える
### スワップの発生
- スワップが発生する原因
  - 物理メモリが足りない
  - 物理メモリのフラグメンテーションが進んでまとまったメモリを確保できない
- 物理メモリが足りない時の1つの対処法
  1. 物理メモリの増設
- フラグメンテーションの2つの対処法
  1. 大量のメモリを使っているプロセスを終了させることで、仮想メモリ空間を解放する
  2. スワップを開放する
    - ディスクI/O負荷が高く、重い処理なので注意が必要
### 空き物理メモリが足りなく見える
- ページキャッシュされているから足りなく見える
- キャッシュには、ページキャッシュとバッファキャッシュがある
- ページキャッシュはファイルにアクセスすればするほど肥大化していく
### バックアップとページキャッシュ
- バックアップを取ることはファイルにアクセスすることなので、ページキャッシュされてしまう
- 一時的にしか使わないバックアップをページキャッシュに取られてしまうことで、アプリケーションのデータがディスク(HDD)に追い出されてしまってサーバ負荷が上がってしまう
- 対策
  - ddコマンドでブロック単位でバックアップを取る方法がある

<br></br>

## ファイル管理
- 後で見る

---

<br></br>

# ネットワーク
## ネットワークとネットワーク機器
- 1対1のコンピュータを接続
  - ケーブルでつなげばいい
  - AWSだと同一のサブネット間の通信
- 3台数以上のコンピュータを接続
  - 分岐点(L2スイッチ)を設けて直接接続すればいい
  - AWSだと同一のサブネット間の通信
- 複数の分岐ポイントがある接続
  - 分岐点(L2スイッチ)を複数にすればいい
  - AWSだと同一のサブネット間の通信
- 距離が離れた拠点同士の通信
  - 分岐点にネットワーク機器(ルータやL3スイッチ)を配置する
  - インターネットの外に出たいならルータが必要
  - AWSだと異なるサブネット間の通信で、サブネットに付随しているルーティングテーブルで設定する

<br></br>

## ルータのルーティング方法
### 静的ルーティング(スタティックルーティング)
### 動的ルーティング(ダイナミックルーティング)
- IGPとEGPの二種類に分かれる

<br></br>

## VLANの種類
### ポートVLAN
- VLANを搭載したL2スイッチによってセグメントを分けることで実現
- P97
### タグVLAN
- VLANを搭載したL2スイッチ同士をL3スイッチやルータで接続して、異なるスイッチのVLAN間の通信を実現
- P98

<br></br>

## セキュリティグループとネットワークACLの違い
- サブネット = L2スイッチで分岐したコンピュータ郡
- 異なるサブネット間 = L3スイッチで分岐したコンピュータ郡
- セキュリティグループ = コンピュータ毎のファイアウォール
- ネットワークACL = サブネット毎のファイアウォール = L2スイッチでのファイアウォール(ACL)

<br></br>

## NAT
- ルータがパケットを受け取るとIPアドレスを動的に変換して送り出す機能
- 静的NAT
- 動的NAT
- NAPT/IPマスカレード
- 用途
  - プライベートIPが振られたPCがインターネットに出たいときにグローバルIPアドレスが必要になるケース

<br></br>

## インフラエンジニアのネットワーク管理
### IPアドレス計画
- 後で見るか、調べる

---

<br></br>

# データベース(P112から)
## PostgreSQLとMySQLの違い、メリットデメリット
