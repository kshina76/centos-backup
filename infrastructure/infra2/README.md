# インフラエンジニアの教科書2 メモ
# プロトコル
### ロードバランサー
- L3スイッチ: L3以下で動作するスイッチ、IPアドレスを見てスイッチング
- L4スイッチ/ロードバランサー: L4以下で動作するスイッチ、IPアドレス+ポートを見てスイッチング
- L7スイッチ/ロードバランサー: L7以下で動作するスイッチ、URLを見てスイッチング
- L4とかL7`以下`の`以下`が重要。決してL4だけで動作するからポートしか見ないのかと言われるとそういうわけではないので注意

### 独自プロトコル
- HTTP上で動作するL8に該当するプロトコルを構築してアプリケーションをその上で作成したりといったことがある
  - ゲームとか
- TCPを使っているHTTPより、もっとスリムで早く動作するプロトコルを作ってゲームを載せたりといったこともある
- SQLなども独自プロトコルを定義して通信されている
  - https://www.javadrive.jp/pear/pear_db/index2.html

  ![netag099](https://user-images.githubusercontent.com/53253817/102680024-2138d680-41f8-11eb-8c89-c1aa9c645e4a.gif)

### ジョン・ポステル博士への追悼文
- RFC2468
- RFC2441

### TCP
- トランスポート層でパケットを分割して、最初に以下の3-way-handshakeが行われる
  1. 送信元が通信路を確保するため、相手にデータ転送の許可要求を出す。（SYN）
  2. 宛先側が許可を送信元に知らせると同時に受信側も許可要求を出す。（ACK + SYN）
  3. 最初にSYNを送った送信元も宛先側に許可を出す。（ACK）
- 3-way-handshakeも普通のパケット同じように、「IP層->データリンク層->物理層」を通って相手に届く
  - ただし、シーケンス番号はランダムな値になる
- トランスポート層でデータがパケットに分解されて、トランスポート層を起点にパケットを一つ一つ流していく。そのパケットたちは「IP層->データリンク層->物理層」を通って相手のマシンに届く
- 一つのパケットが届くたびに、TCPの確認作業が入るため(ACKとかSYNとか)、UDPと比べて通信が遅くなる
- 参考文献
  - https://qiita.com/tatsuya4150/items/ae4d5e95e43ce0670bc0

### ICMP
- pingやtrace routeを遮断するような運用をしているサーバがあるが、「ブラックホールルータ」という現象が起きる可能性がある
- ブラックホールルータとは
  - ルータ間のMTUの調整ができなくなる問題がある
  - MTUの調整ができないと、パケットの分割が必要な時に、相手側のルータにそのことが伝えられずにパケットが失われる問題
- pingやtrace routeを防ぐ目的があるなら、ICMPの内の「Echo Reply」のみを遮断する方法が安全

### コネクションとセッションの違い

### FTP
- 制御用とデータ転送用の二つのTCPコネクションを使う
- FTPにはアクティブモードとパッシブモードがある
- P28の画像

### SNMP

### ファイアーウォールの機能
- 動的ポートフィルタリング

---

<br></br>

# OS
## プロセスとスレッド
### プロセス
- プロセスはOS上での処理の最小実行単位
- プロセスは、`ls`や`cd`の基本的なコマンドだろうが、スクリプトであろうが、OSSであろうが、商用ソフトであろうとも、OS上は全てプロセスの単位で実行される
- プロセスには親子関係があって、プロセスの生成は親プロセスを`複製(fork)`することでのみ行える。CoWという仕組みによって負荷を軽減してforkすることができる
- fork後は、`exec`と呼ばれるプロセスの中身を別のプログラムに丸ごと置き換える方法で処理を切り替えることができる
- プロセスは状態を遷移する
  1. 休止中
  2. 実行待ち
  3. 実行中
  4. etc
- プロセスは何かの処理を行う段階になると`実行待ち状態`に遷移する
- `実行待ち状態`でCPUからCPUリソース(CPUコア一つ)が割り当てられると、`実行中`に遷移する
- プロセス同士は共通のデータを参照・更新することができず、`プロセス間通信`という仕組みを介してデータの受け渡しを行う
- プロセスの制御は`シグナル`という仕組みで行う
  - 強制終了するとき`Ctrl-C`とかもシグナルの一種
### スレッド
- プロセスの内部に複数のスレッドを生成することができる。forkより軽い
- 同じプロセス内のスレッド同士は共通のデータの参照・更新をすることができる
- 複数のスレッドが競合して共通のデータが更新されないように`ミューテックス`や`セマフォ`などの排他制御の仕組みがある
- スレッドは軽量プロセスとも呼ばれ、OSからCPUの割り当てを受けてプロセスのように動作させることができる
- スレッドの例
  - ダウンロードとプログレスバー
### プロセスの構成要素
- PID
- プログラムの実行命令コード
- 変数などのデータ
- ファイル記述子(ファイルデスクリプタ、ファイルハンドルとも呼ぶ)
- コンテキスト(CPUの持つレジスタ情報や物理メモリのアドレッシングなどを保持しておき、コンテキストスイッチに備える)
- スレッド
### プロセスの親子関係と新しいプロセスの生成
- UNIX/LinuxはOS起動時にinitプロセスから起動する
- 全てのプロセスはinitプロセスの子孫プロセスになる
- `bash`を開いて、`lsコマンド`を処理する流れ
  - `bashプロセスA`を二つにfork->`bashプロセスA'`、`bashプロセスA''`->`bashプロセスA''`をexecシステムコールで`lsプロセスB`に書き換える
  - P38
### プロセス間通信
- `cat /var/log/messages | grep Error`のようなパイプ処理もプロセス間通信
  - catプロセスとgrepプロセスの通信は異なるプロセスなので、プロセス間通信
### 実行待ちキュー
- プロセスとスレッドが区別なく実行待ちキューな入っていて、CPUにリソースを割り当てられることで順番にキューから出ていく
- マルチコアCPUだとキューから複数のプロセスやスレッドを取っていくことができるので、ユーザが感じる速度が速くなる
### シグナル
- シグナルの種類
  - SIGHUP
  - SIGINT
  - SIGKILL
  - SIGTERM
  - SIGTSTP
- killコマンドで各種シグナルを送ることができる
