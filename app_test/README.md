# 初めての自動テスト　書籍メモ

## 1.テストのピラミッド

### 1-1.先人の教訓
1. 全ての自動テストが同等の力を持つわけではない
2. テストを「書くことができる」状態が、「書くべき」だという理由にはならない
3. スピードとフィードバックが重要
- つまり、1つのテストが万能薬のように働くことはない！
  - うまく組み合わせて用いることが必要

### 1-2.テストのピラミッド
- UIテスト（Presentation層〜infra層）
  - メリット
    - エンドツーエンドで動く
    - ユーザと同じ対象を見る
  - デメリット
    - 高コストで遅い
  
- 統合テスト（usecase層〜infra層）
  - メリット
    - WebサービスとAPIがテストできる
    - つながりを見られる
  - デメリット
    - 詳細さに欠ける

- ユニットテスト（infra層）
  - メリット
    - 超高速
    - 多目的に利用できる
  - デメリット
    - 結合部分の確認に弱い

![https---qiita-image-store s3 ap-northeast-1 amazonaws com-0-390780-0e68ad80-e3a8-cc79-6be2-3bbe69d24389](https://user-images.githubusercontent.com/53253817/100713784-2b856300-33f8-11eb-83e6-c496e336937c.png)

### 1-3.自動テストの方針
- UIテストよりユニットテストを優先する
- ユニットテストで埋められない部分を統合テストでカバーする
- UIテストは限定的に使う
- まず「ユニットテストでカバーできないか？」を考える
  - ユニットテストでカバーできないなら、統合テストでカバーできるか考えるといったように段階的にどの層テストを適用するか考える
- 全てを自動化しようとせず、代わりに、過不足なく自動化すること
- 上位と下位のテストがかぶることもある
  - ただしそれらはスコープが違う
  - 協調して無意味な重複を避けていくことが大事
- 探索的テスト(手順化されてないテスト)も忘れないこと

### 1章の疑問
- レイヤードアーキテクチャで考えたときにpresentation、usecase、infraのそれぞれをユニットテストすることはないのか？
  - 上の説明だとusecase層をテストすることは統合テストを行うのであって、ユニットテストをすることでは内容に見えるが

- 探索的テストってなんだろう？

<br></br>

## 2.UIテストに触れる

### 2-2.UIテストを始める
- UIテストの手順
  1. 自分がユーザになりきって、どのような手順を踏むか自然言語で書き出す
    - ログイン画面を開く
    - メールアドレスを入力する
    - パスワードを入力する
    - サインインボタンをクリックする
    - welcomeというメッセージが表示されていることを確認する
  2. 自然言語をコードに変換する
    - １の手順を一行一行コードに変換するだけ

    ```ruby
    describe 'should be able to login' do  #テスト名
      let(:user) { FactoryGirl.create(:user) }  #ダミーテスト作成
      before do
        visit login_path  #URLを叩いてログイン画面を開く
        fill_in 'Email', with: user.email  #ダミーテストを参照してテキストボックスを埋める
        fill_in 'Pasword', with: user.password  #同じくダミーテストを参照してテキストボックスを埋める
        click_button 'Sign in'  #サインインボタンをクリックする
      end
      it { should have_selector('h1', text: 'Welcome') }  #ログイン後の画面にh1タグのWelcomeが表示されているかを確認する
    end
    ```

### 2-3~6.UIテストでの遷移先の検証
- UIテストで遷移先の画面が正しいかを判定する方法
  - HTMLタグをCSSセレクタを使って取得することで、遷移先の画面が正しいかを判別する
  - HTMLタグのclassを指定してしまうと、被る可能性があるので、IDを指定する
  - HTMLを開発するときにテストで取得するタグには「できるだけ」IDタグを付与するようにする
  - IDタグを付与する場所は「テストで取得する箇所」と「JavaScriptを適用する箇所」

<br></br>

## 3.レガシーシステムにUIテストを追加する

### 3-1~2.UIテストを適用するステップ
1. URLが意図している画面に遷移するかを確認する
  - URLを叩いた先のHTMLをprintとかで取得して、テストした画面に行けるかを目視する
2. 正しいCSSセレクタを見つける(どちらかの方法で)
  - 「ソースを表示してHTMLから自力でタグを探して、IDかclassが付与されていなかったら付与する」
  - 「デベロッパーツールを使って、CSSセレクタを取得して、IDかclassが付与されていなかったら付与する」
